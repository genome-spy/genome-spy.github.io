var v=Object.defineProperty;var F=(n,e,t)=>e in n?v(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var f=(n,e,t)=>F(n,typeof e!="symbol"?e+"":e,t);const y=/%([0-9A-Fa-f]{2})/g,R=/^\s*##\s*(\S+)\s*(.*)/,g=/\r?\n$/,b=/\s+/,C=/\D/g;function p(n){return n.includes("%")?n.replaceAll(y,(e,t)=>String.fromCharCode(parseInt(t,16))):n}function k(n){if(!n.length||n===".")return{};const e={};let t=n;t.endsWith(`
`)&&(t=t.slice(0,t.endsWith(`\r
`)?-2:-1));for(const r of t.split(";")){const s=r.indexOf("=");if(s===-1)continue;const c=r.slice(s+1);if(!c.length)continue;const i=r.slice(0,s).trim();let o=e[i];o||(o=[],e[i]=o);for(const l of c.split(","))o.push(p(l.trim()))}return e}function I(n){if(!n.length||n===".")return{};const e={};let t=n;t.endsWith(`
`)&&(t=t.slice(0,t.endsWith(`\r
`)?-2:-1));for(const r of t.split(";")){const s=r.indexOf("=");if(s===-1)continue;const c=r.slice(s+1);if(!c.length)continue;const i=r.slice(0,s).trim();let o=e[i];o||(o=[],e[i]=o);for(const l of c.split(","))o.push(l.trim())}return e}function L(n){return _(n.split("	"))}function a(n){return n==="."||n===""||n===void 0?null:n}function _(n){const e=a(n[0]),t=a(n[1]),r=a(n[2]),s=a(n[3]),c=a(n[4]),i=a(n[5]),o=a(n[6]),l=a(n[7]),u=a(n[8]);return{seq_id:e?p(e):null,source:t?p(t):null,type:r?p(r):null,start:s===null?null:parseInt(s,10),end:c===null?null:parseInt(c,10),score:i===null?null:parseFloat(i),strand:o,phase:l,attributes:u===null?null:k(u)}}function D(n){const e=a(n[0]),t=a(n[1]),r=a(n[2]),s=a(n[3]),c=a(n[4]),i=a(n[5]),o=a(n[6]),l=a(n[7]),u=a(n[8]);return{seq_id:e,source:t,type:r,start:s===null?null:parseInt(s,10),end:c===null?null:parseInt(c,10),score:i===null?null:parseFloat(i),strand:o,phase:l,attributes:u===null?null:I(u)}}function A(n){var c,i;const e=R.exec(n);if(!e)return null;const[,t]=e;let[,,r]=e;const s={directive:t};if(r.length&&(r=r.replace(g,""),s.value=r),t==="sequence-region"){const o=r.split(b,3);return{...s,seq_id:o[0],start:(c=o[1])==null?void 0:c.replaceAll(C,""),end:(i=o[2])==null?void 0:i.replaceAll(C,"")}}else if(t==="genome-build"){const[o,l]=r.split(b,2);return{...s,source:o,buildName:l}}return s}const x=/^\s*[^#\s>]/,w=/^\s*(#+)(.*)/,S=/^\s*$/,E=/^\s*>/,P=/\r?\n?$/g;class m{constructor(e){f(this,"featureCallback");f(this,"endCallback");f(this,"commentCallback");f(this,"errorCallback");f(this,"disableDerivesFromReferences");f(this,"directiveCallback");f(this,"bufferSize");f(this,"eof",!1);f(this,"lineNumber",0);f(this,"_underConstructionTopLevel",[]);f(this,"_underConstructionById",{});f(this,"_completedReferences",{});f(this,"_underConstructionOrphans",{});const t=()=>{};this.featureCallback=e.featureCallback||t,this.endCallback=e.endCallback||t,this.commentCallback=e.commentCallback||t,this.errorCallback=e.errorCallback||t,this.directiveCallback=e.directiveCallback||t,this.disableDerivesFromReferences=e.disableDerivesFromReferences||!1,this.bufferSize=e.bufferSize===void 0?1/0:e.bufferSize}addLine(e){if(this.eof)return;if(this.lineNumber+=1,x.test(e)){this._bufferLine(e);return}const t=w.exec(e);if(t){const[,r]=t;let[,,s]=t;if(r.length===3)this._emitAllUnderConstructionFeatures();else if(r.length===2){const c=A(e);c&&(c.directive==="FASTA"?(this._emitAllUnderConstructionFeatures(),this.eof=!0):this._emitItem(c))}else this._emitItem({comment:s.trimStart()})}else if(!S.test(e))if(E.test(e))this._emitAllUnderConstructionFeatures(),this.eof=!0;else{const r=e.replaceAll(P,"");throw new Error(`GFF3 parse error.  Cannot parse '${r}'.`)}}addParsedFeatureLine(e){this.eof||(this.lineNumber+=1,this._bufferParsedLine(e))}finish(){this._emitAllUnderConstructionFeatures(),this.endCallback()}_emitItem(e){Array.isArray(e)?this.featureCallback(e):"directive"in e?this.directiveCallback(e):"comment"in e&&this.commentCallback(e)}_enforceBufferSizeLimit(e=0){const t=r=>{var s,c;r&&Array.isArray(r)&&((c=(s=r[0].attributes)==null?void 0:s.ID)!=null&&c[0])&&(r[0].attributes.ID.forEach(o=>{delete this._underConstructionById[o],delete this._completedReferences[o]}),r.forEach(o=>{o.child_features&&o.child_features.forEach(l=>{t(l)}),o.derived_features&&o.derived_features.forEach(l=>{t(l)})}))};for(;this._underConstructionTopLevel.length+e>this.bufferSize;){const r=this._underConstructionTopLevel.shift();r&&(this._emitItem(r),t(r))}}_emitAllUnderConstructionFeatures(){this._underConstructionTopLevel.forEach(this._emitItem.bind(this)),this._underConstructionTopLevel=[],this._underConstructionById={},this._completedReferences={};const e=Object.keys(this._underConstructionOrphans);if(e.length)throw new Error(`some features reference other features that do not exist in the file (or in the same '###' scope). ${e.join(",")}`)}_bufferLine(e){this._bufferParsedLine(L(e))}_bufferParsedLine(e){var o,l,u;const t=e;t.child_features=[],t.derived_features=[];const r=((o=t.attributes)==null?void 0:o.ID)||[],s=((l=t.attributes)==null?void 0:l.Parent)||[],c=this.disableDerivesFromReferences?[]:((u=t.attributes)==null?void 0:u.Derives_from)||[];if(!r.length&&!s.length&&!c.length){this._emitItem([t]);return}let i;r.forEach(d=>{const h=this._underConstructionById[d];h?(h[h.length-1].type!==t.type&&this._parseError(`multi-line feature "${d}" has inconsistent types: "${t.type}", "${h[h.length-1].type}"`),h.push(t),i=h):(i=[t],this._enforceBufferSizeLimit(1),!s.length&&!c.length&&this._underConstructionTopLevel.push(i),this._underConstructionById[d]=i,this._resolveReferencesTo(i,d))}),this._resolveReferencesFrom(i||[t],{Parent:s,Derives_from:c},r)}_resolveReferencesTo(e,t){const r=this._underConstructionOrphans[t];if(r){for(const s of e)s.child_features.push(...r.Parent),s.derived_features.push(...r.Derives_from);delete this._underConstructionOrphans[t]}}_parseError(e){this.eof=!0,this.errorCallback(`${this.lineNumber}: ${e}`)}_resolveReferencesFrom(e,t,r){for(const s of t.Parent){const c=this._underConstructionById[s];if(c){let i=!1;for(const o of r){const l=`Parent,${s}`,u=this._completedReferences[o]||(this._completedReferences[o]={});u[l]&&(i=!0),u[l]=!0}if(!i)for(const o of c)o.child_features.push(e)}else{let i=this._underConstructionOrphans[s];i||(i={Parent:[],Derives_from:[]},this._underConstructionOrphans[s]=i),i.Parent.push(e)}}for(const s of t.Derives_from){const c=this._underConstructionById[s];if(c){let i=!1;for(const o of r){const l=`Derives_from,${s}`,u=this._completedReferences[o]||(this._completedReferences[o]={});u[l]&&(i=!0),u[l]=!0}if(!i)for(const o of c)o.derived_features.push(e)}else{let i=this._underConstructionOrphans[s];i||(i={Parent:[],Derives_from:[]},this._underConstructionOrphans[s]=i),i.Derives_from.push(e)}}}}function $(n){const e=[],t=new m({featureCallback:r=>e.push(r),disableDerivesFromReferences:!0,errorCallback:r=>{throw new Error(r)}});for(const r of n.split(/\r?\n/))t.addLine(r);return t.finish(),e}function B(n){const e=[],t=new m({featureCallback:r=>e.push(r),disableDerivesFromReferences:!0,errorCallback:r=>{throw new Error(r)}});for(const r of n)t.addLine(r);return t.finish(),e}function T(n){const e=[],t=new m({featureCallback:r=>e.push(r),disableDerivesFromReferences:!0,errorCallback:r=>{throw new Error(r)}});for(const r of n){const s=_(r.fields);r.lineHash!==void 0&&(s.attributes||(s.attributes={}),s.attributes._lineHash=[String(r.lineHash)]),t.addParsedFeatureLine(s)}return t.finish(),e}function q(n,e){const t=[],r=new m({featureCallback:c=>t.push(c),disableDerivesFromReferences:!0,errorCallback:c=>{throw new Error(c)}}),s=e?_:D;for(const c of n){const i=s(c.fields);c.lineHash!==void 0&&(i.attributes||(i.attributes={}),i.attributes._lineHash=[String(c.lineHash)]),r.addParsedFeatureLine(i)}return r.finish(),t}export{B as parseArraySync,T as parseRecordsSync,q as parseRecordsSyncFast,$ as parseStringSync};
