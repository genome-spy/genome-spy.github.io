import{L as Y,u as P,a as Q}from"./long-lo7kSskr.js";import{b as y}from"./index-D1-7ym7j.js";import{L as C}from"./__vite-browser-external-D80GqXp3.js";import{R as L}from"./remoteFile-Bm2xbUQM.js";import{A as W,L as X}from"./index-MItgq5d9.js";import"./_commonjsHelpers-C932wzq6.js";import"./index-ClfaVKLN.js";class O{constructor(e,t){this.blockPosition=e,this.dataPosition=t}toString(){return`${this.blockPosition}:${this.dataPosition}`}compareTo(e){return this.blockPosition-e.blockPosition||this.dataPosition-e.dataPosition}static min(...e){let t,n=0;for(;!t;n+=1)t=e[n];for(;n<e.length;n+=1)t.compareTo(e[n])>0&&(t=e[n]);return t}}function E(o,e=0,t=!1){if(t)throw new Error("big-endian virtual file offsets not implemented");return new O(o[e+7]*1099511627776+o[e+6]*4294967296+o[e+5]*16777216+o[e+4]*65536+o[e+3]*256+o[e+2],o[e+1]<<8|o[e])}class F{constructor(e,t,n,r){this.minv=e,this.maxv=t,this.bin=n,this._fetchedSize=r}toUniqueString(){return`${this.minv.toString()}..${this.maxv.toString()} (bin ${this.bin}, fetchedSize ${this.fetchedSize()})`}toString(){return this.toUniqueString()}compareTo(e){return this.minv.compareTo(e.minv)||this.maxv.compareTo(e.maxv)||this.bin-e.bin}fetchedSize(){return this._fetchedSize!==void 0?this._fetchedSize:this.maxv.blockPosition+65536-this.minv.blockPosition}}function J(o){return new Promise(e=>setTimeout(e,o))}function K(o){if(o&&o.aborted)if(typeof DOMException>"u"){const e=new Error("aborted");throw e.code="ERR_ABORTED",e}else throw new DOMException("aborted","AbortError")}function Z(o,e){return e.minv.blockPosition-o.maxv.blockPosition<65e3&&e.maxv.blockPosition-o.minv.blockPosition<5e6}function ee(o={}){return"aborted"in o?{signal:o}:o}function z(o,e){const t=[];let n;if(o.length===0)return o;o.sort((r,s)=>{const i=r.minv.blockPosition-s.minv.blockPosition;return i===0?r.minv.dataPosition-s.minv.dataPosition:i});for(const r of o)(!e||r.maxv.compareTo(e)>0)&&(n===void 0?(t.push(r),n=r):Z(n,r)?r.maxv.compareTo(n.maxv)>0&&(n.maxv=r.maxv):(t.push(r),n=r));return t}function G(o,e){return{lineCount:Y.fromBytesLE(Array.prototype.slice.call(o,e,e+8),!0).toNumber()}}function S(o,e){return o?o.compareTo(e)>0?e:o:e}function te(o,e=t=>t){let t=0,n=0;const r=[],s={};for(let i=0;i<o.length;i+=1)if(!o[i]){if(n<i){let c=o.toString("utf8",n,i);c=e(c),r[t]=c,s[c]=t}n=i+1,t+=1}return{refNameToId:s,refIdToName:r}}class H{constructor({filehandle:e,renameRefSeq:t=n=>n}){this.filehandle=e,this.renameRefSeq=t}}const ne=21578050;function re(o,e){return o-o%e}function se(o,e){return o-o%e+e}function ie(o,e){return e-=1,[[0,0],[1+(o>>26),1+(e>>26)],[9+(o>>23),9+(e>>23)],[73+(o>>20),73+(e>>20)],[585+(o>>17),585+(e>>17)],[4681+(o>>14),4681+(e>>14)]]}class v extends H{async lineCount(e,t){var n,r;return((r=(n=(await this.parse(t)).indices[e])===null||n===void 0?void 0:n.stats)===null||r===void 0?void 0:r.lineCount)||0}async _parse(e){const t=await this.filehandle.readFile(e);if(t.readUInt32LE(0)!==ne)throw new Error("Not a BAI file");const n=t.readInt32LE(4),s=((1<<(5+1)*3)-1)/7;let i=8,c;const a=new Array(n);for(let d=0;d<n;d++){const f=t.readInt32LE(i);let h;i+=4;const l={};for(let b=0;b<f;b+=1){const u=t.readUInt32LE(i);if(i+=4,u===s+1)i+=4,h=G(t,i+16),i+=32;else{if(u>s+1)throw new Error("bai index contains too many bins, please use CSI");{const g=t.readInt32LE(i);i+=4;const w=new Array(g);for(let _=0;_<g;_++){const I=E(t,i);i+=8;const M=E(t,i);i+=8,c=S(c,I),w[_]=new F(I,M,u)}l[u]=w}}}const x=t.readInt32LE(i);i+=4;const m=new Array(x);for(let b=0;b<x;b++){const u=E(t,i);i+=8,c=S(c,u),m[b]=u}a[d]={binIndex:l,linearIndex:m,stats:h}}return{bai:!0,firstDataLine:c,maxBlockSize:65536,indices:a,refCount:n}}async indexCov(e,t,n,r={}){const i=t!==void 0,a=(await this.parse(r)).indices[e];if(!a)return[];const{linearIndex:d=[],stats:f}=a;if(d.length===0)return[];const h=n===void 0?(d.length-1)*16384:se(n,16384),l=t===void 0?0:re(t,16384),x=i?new Array((h-l)/16384):new Array(d.length-1),m=d[d.length-1].blockPosition;if(h>(d.length-1)*16384)throw new Error("query outside of range of linear index");let b=d[l/16384].blockPosition;for(let u=l/16384,g=0;u<h/16384;u++,g++)x[g]={score:d[u+1].blockPosition-b,start:u*16384,end:u*16384+16384},b=d[u+1].blockPosition;return x.map(u=>({...u,score:u.score*((f==null?void 0:f.lineCount)||0)/m}))}async blocksForRange(e,t,n,r={}){t<0&&(t=0);const s=await this.parse(r);if(!s)return[];const i=s.indices[e];if(!i)return[];const c=ie(t,n),a=[];for(const[x,m]of c)for(let b=x;b<=m;b++)if(i.binIndex[b]){const u=i.binIndex[b];for(const g of u)a.push(new F(g.minv,g.maxv,b))}const d=i.linearIndex.length;let f;const h=Math.min(t>>14,d-1),l=Math.min(n>>14,d-1);for(let x=h;x<=l;++x){const m=i.linearIndex[x];m&&(!f||m.compareTo(f)<0)&&(f=m)}return z(a,f)}async parse(e={}){return this.setupP||(this.setupP=this._parse(e).catch(t=>{throw this.setupP=void 0,t})),this.setupP}async hasRefSeq(e,t={}){var n;return!!(!((n=(await this.parse(t)).indices[e])===null||n===void 0)&&n.binIndex)}}let B=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];typeof Int32Array<"u"&&(B=new Int32Array(B));const ae=(o,e)=>{let t=e===0?0:~~e^-1;for(let n=0;n<o.length;n++)t=B[(t^o[n])&255]^t>>>8;return t^-1},N=(o,e)=>y.Buffer.from(o,e);function oe(o,e){const t=(n,r)=>e(N(n),r)>>>0;return t.signed=(n,r)=>e(N(n),r),t.unsigned=t,t.model=o,t}const ce=oe("crc-32",ae),de=21582659,fe=38359875;function he(o,e){return o*2**e}function q(o,e){return Math.floor(o/2**e)}class T extends H{constructor(){super(...arguments),this.maxBinNumber=0,this.depth=0,this.minShift=0}async lineCount(e,t){var n,r;return((r=(n=(await this.parse(t)).indices[e])===null||n===void 0?void 0:n.stats)===null||r===void 0?void 0:r.lineCount)||0}async indexCov(){return[]}parseAuxData(e,t){const n=e.readInt32LE(t),r=n&65536?"zero-based-half-open":"1-based-closed",s={0:"generic",1:"SAM",2:"VCF"}[n&15];if(!s)throw new Error(`invalid Tabix preset format flags ${n}`);const i={ref:e.readInt32LE(t+4),start:e.readInt32LE(t+8),end:e.readInt32LE(t+12)},c=e.readInt32LE(t+16),a=c?String.fromCharCode(c):"",d=e.readInt32LE(t+20),f=e.readInt32LE(t+24);return{columnNumbers:i,coordinateType:r,metaValue:c,metaChar:a,skipLines:d,format:s,formatFlags:n,...te(e.subarray(t+28,t+28+f),this.renameRefSeq)}}async _parse(e){const t=await this.filehandle.readFile(e),n=await P(t);let r;if(n.readUInt32LE(0)===de)r=1;else if(n.readUInt32LE(0)===fe)r=2;else throw new Error("Not a CSI file");this.minShift=n.readInt32LE(4),this.depth=n.readInt32LE(8),this.maxBinNumber=((1<<(this.depth+1)*3)-1)/7;const s=n.readInt32LE(12),i=s>=30?this.parseAuxData(n,16):void 0,c=n.readInt32LE(16+s);let a=16+s+4,d;const f=new Array(c);for(let h=0;h<c;h++){const l=n.readInt32LE(a);a+=4;const x={};let m;for(let b=0;b<l;b++){const u=n.readUInt32LE(a);if(a+=4,u>this.maxBinNumber)m=G(n,a+28),a+=44;else{d=S(d,E(n,a)),a+=8;const g=n.readInt32LE(a);a+=4;const w=new Array(g);for(let _=0;_<g;_+=1){const I=E(n,a);a+=8;const M=E(n,a);a+=8,d=S(d,I),w[_]=new F(I,M,u)}x[u]=w}}f[h]={binIndex:x,stats:m}}return{csiVersion:r,firstDataLine:d,indices:f,refCount:c,csi:!0,maxBlockSize:65536,...i}}async blocksForRange(e,t,n,r={}){t<0&&(t=0);const i=(await this.parse(r)).indices[e];if(!i)return[];const c=this.reg2bins(t,n);if(c.length===0)return[];const a=[];for(const[d,f]of c)for(let h=d;h<=f;h++)if(i.binIndex[h]){const l=i.binIndex[h];for(const x of l)a.push(x)}return z(a,new O(0,0))}reg2bins(e,t){e-=1,e<1&&(e=1),t>2**50&&(t=2**34),t-=1;let n=0,r=0,s=this.minShift+this.depth*3;const i=[];for(;n<=this.depth;s-=3,r+=he(1,n*3),n+=1){const c=r+q(e,s),a=r+q(t,s);if(a-c+i.length>this.maxBinNumber)throw new Error(`query ${e}-${t} is too large for current binning scheme (shift ${this.minShift}, depth ${this.depth}), try a smaller query or a coarser index binning scheme`);i.push([c,a])}return i}async parse(e={}){return this.setupP||(this.setupP=this._parse(e).catch(t=>{throw this.setupP=void 0,t})),this.setupP}async hasRefSeq(e,t={}){var n;return!!(!((n=(await this.parse(t)).indices[e])===null||n===void 0)&&n.binIndex)}}const p={BAM_FPAIRED:1,BAM_FPROPER_PAIR:2,BAM_FUNMAP:4,BAM_FMUNMAP:8,BAM_FREVERSE:16,BAM_FMREVERSE:32,BAM_FREAD1:64,BAM_FREAD2:128,BAM_FSECONDARY:256,BAM_FQCFAIL:512,BAM_FDUP:1024,BAM_FSUPPLEMENTARY:2048},D="=ACMGRSVTWYHKDBN".split(""),A="MIDNSHP=X???????".split("");class R{constructor(e){this.bytes=e.bytes,this.fileOffset=e.fileOffset}get byteArray(){return this.bytes.byteArray}get flags(){return(this.byteArray.readInt32LE(this.bytes.start+16)&4294901760)>>16}get ref_id(){return this.byteArray.readInt32LE(this.bytes.start+4)}get start(){return this.byteArray.readInt32LE(this.bytes.start+8)}get end(){return this.start+this.length_on_ref}get id(){return this.fileOffset}get mq(){const e=(this.bin_mq_nl&65280)>>8;return e===255?void 0:e}get score(){return this.mq}get qual(){if(this.isSegmentUnmapped())return;const e=this.b0+this.read_name_length+this.num_cigar_ops*4+this.num_seq_bytes;return this.byteArray.subarray(e,e+this.seq_length)}get strand(){return this.isReverseComplemented()?-1:1}get b0(){return this.bytes.start+36}get name(){return this.byteArray.toString("ascii",this.b0,this.b0+this.read_name_length-1)}get tags(){const{byteArray:e}=this.bytes;let t=this.b0+this.read_name_length+this.num_cigar_ops*4+this.num_seq_bytes+this.seq_length;const n=this.bytes.end,r={};for(;t<n;){const s=String.fromCharCode(e[t],e[t+1]),i=String.fromCharCode(e[t+2]);if(t+=3,i==="A")r[s]=String.fromCharCode(e[t]),t+=1;else if(i==="i")r[s]=e.readInt32LE(t),t+=4;else if(i==="I")r[s]=e.readUInt32LE(t),t+=4;else if(i==="c")r[s]=e.readInt8(t),t+=1;else if(i==="C")r[s]=e.readUInt8(t),t+=1;else if(i==="s")r[s]=e.readInt16LE(t),t+=2;else if(i==="S")r[s]=e.readUInt16LE(t),t+=2;else if(i==="f")r[s]=e.readFloatLE(t),t+=4;else if(i==="Z"||i==="H"){const c=[];for(;t<=n;){const a=e[t++];if(a!==0)c.push(String.fromCharCode(a));else break}r[s]=c.join("")}else if(i==="B"){const c=e[t++],a=String.fromCharCode(c),d=e.readInt32LE(t);if(t+=4,a==="i")if(s==="CG"){const f=[];for(let h=0;h<d;h++){const l=e.readInt32LE(t),x=l>>4,m=A[l&15];f.push(x+m),t+=4}r[s]=f.join("")}else{const f=[];for(let h=0;h<d;h++)f.push(e.readInt32LE(t)),t+=4;r[s]=f}else if(a==="I")if(s==="CG"){const f=[];for(let h=0;h<d;h++){const l=e.readUInt32LE(t),x=l>>4,m=A[l&15];f.push(x+m),t+=4}r[s]=f.join("")}else{const f=[];for(let h=0;h<d;h++)f.push(e.readUInt32LE(t)),t+=4;r[s]=f}else if(a==="s"){const f=[];for(let h=0;h<d;h++)f.push(e.readInt16LE(t)),t+=2;r[s]=f}else if(a==="S"){const f=[];for(let h=0;h<d;h++)f.push(e.readUInt16LE(t)),t+=2;r[s]=f}else if(a==="c"){const f=[];for(let h=0;h<d;h++)f.push(e.readInt8(t)),t+=1;r[s]=f}else if(a==="C"){const f=[];for(let h=0;h<d;h++)f.push(e.readUInt8(t)),t+=1;r[s]=f}else if(a==="f"){const f=[];for(let h=0;h<d;h++)f.push(e.readFloatLE(t)),t+=4;r[s]=f}}else{console.error("Unknown BAM tag type",i);break}}return r}isPaired(){return!!(this.flags&p.BAM_FPAIRED)}isProperlyPaired(){return!!(this.flags&p.BAM_FPROPER_PAIR)}isSegmentUnmapped(){return!!(this.flags&p.BAM_FUNMAP)}isMateUnmapped(){return!!(this.flags&p.BAM_FMUNMAP)}isReverseComplemented(){return!!(this.flags&p.BAM_FREVERSE)}isMateReverseComplemented(){return!!(this.flags&p.BAM_FMREVERSE)}isRead1(){return!!(this.flags&p.BAM_FREAD1)}isRead2(){return!!(this.flags&p.BAM_FREAD2)}isSecondary(){return!!(this.flags&p.BAM_FSECONDARY)}isFailedQc(){return!!(this.flags&p.BAM_FQCFAIL)}isDuplicate(){return!!(this.flags&p.BAM_FDUP)}isSupplementary(){return!!(this.flags&p.BAM_FSUPPLEMENTARY)}get cigarAndLength(){if(this.isSegmentUnmapped())return{length_on_ref:0,CIGAR:""};const e=this.num_cigar_ops;let t=this.b0+this.read_name_length;const n=[];let r=this.byteArray.readInt32LE(t),s=r>>4,i=A[r&15];if(i==="S"&&s===this.seq_length)return t+=4,r=this.byteArray.readInt32LE(t),s=r>>4,i=A[r&15],i!=="N"&&console.warn("CG tag with no N tag"),{CIGAR:this.tags.CG,length_on_ref:s};{let c=0;for(let a=0;a<e;++a)r=this.byteArray.readInt32LE(t),s=r>>4,i=A[r&15],n.push(s+i),i!=="H"&&i!=="S"&&i!=="I"&&(c+=s),t+=4;return{CIGAR:n.join(""),length_on_ref:c}}}get length_on_ref(){return this.cigarAndLength.length_on_ref}get CIGAR(){return this.cigarAndLength.CIGAR}get num_cigar_ops(){return this.flag_nc&65535}get read_name_length(){return this.bin_mq_nl&255}get num_seq_bytes(){return this.seq_length+1>>1}get seq(){const{byteArray:e}=this.bytes,t=this.b0+this.read_name_length+this.num_cigar_ops*4,n=this.num_seq_bytes,r=this.seq_length,s=[];let i=0;for(let c=0;c<n;++c){const a=e[t+c];s.push(D[(a&240)>>4]),i++,i<r&&(s.push(D[a&15]),i++)}return s.join("")}get pair_orientation(){if(!this.isSegmentUnmapped()&&!this.isMateUnmapped()&&this.ref_id===this.next_refid){const e=this.isReverseComplemented()?"R":"F",t=this.isMateReverseComplemented()?"R":"F";let n=" ",r=" ";this.isRead1()?(n="1",r="2"):this.isRead2()&&(n="2",r="1");const s=[];return this.template_length>0?(s[0]=e,s[1]=n,s[2]=t,s[3]=r):(s[2]=e,s[3]=n,s[0]=t,s[1]=r),s.join("")}}get bin_mq_nl(){return this.byteArray.readInt32LE(this.bytes.start+12)}get flag_nc(){return this.byteArray.readInt32LE(this.bytes.start+16)}get seq_length(){return this.byteArray.readInt32LE(this.bytes.start+20)}get next_refid(){return this.byteArray.readInt32LE(this.bytes.start+24)}get next_pos(){return this.byteArray.readInt32LE(this.bytes.start+28)}get template_length(){return this.byteArray.readInt32LE(this.bytes.start+32)}toJSON(){const e={};for(const t of Object.keys(this))t.startsWith("_")||t==="bytes"||(e[t]=this[t]);return e}}function k(o,e){const t=Object.getOwnPropertyDescriptor(o.prototype,e);if(!t)throw new Error("OH NO, NO PROPERTY DESCRIPTOR");const n=t.get;if(!n)throw new Error("OH NO, NOT A GETTER");Object.defineProperty(o.prototype,e,{get(){const r=n.call(this);return Object.defineProperty(this,e,{value:r}),r}})}k(R,"tags");k(R,"cigarAndLength");k(R,"seq");k(R,"qual");function j(o){const e=o.split(/\r?\n/),t=[];for(const n of e){const[r,...s]=n.split(/\t/);r&&t.push({tag:r.slice(1),data:s.map(i=>{const c=i.indexOf(":"),a=i.slice(0,c),d=i.slice(c+1);return{tag:a,value:d}})})}return t}const V=21840194,$=65536;async function le(o){let e=[];for await(const t of o)e=e.concat(t);return e}class xe{read(){throw new Error("never called")}stat(){throw new Error("never called")}readFile(){throw new Error("never called")}close(){throw new Error("never called")}}class ue{constructor({bamFilehandle:e,bamPath:t,bamUrl:n,baiPath:r,baiFilehandle:s,baiUrl:i,csiPath:c,csiFilehandle:a,csiUrl:d,htsget:f,yieldThreadTime:h=100,renameRefSeqs:l=x=>x}){if(this.htsget=!1,this.featureCache=new W({cache:new X({maxSize:50}),fill:async(x,m)=>{const{chunk:b,opts:u}=x,{data:g,cpositions:w,dpositions:_}=await this._readChunk({chunk:b,opts:{...u,signal:m}});return this.readBamFeatures(g,w,_,b)}}),this.renameRefSeq=l,e)this.bam=e;else if(t)this.bam=new C(t);else if(n)this.bam=new L(n);else if(f)this.htsget=!0,this.bam=new xe;else throw new Error("unable to initialize bam");if(a)this.index=new T({filehandle:a});else if(c)this.index=new T({filehandle:new C(c)});else if(d)this.index=new T({filehandle:new L(d)});else if(s)this.index=new v({filehandle:s});else if(r)this.index=new v({filehandle:new C(r)});else if(i)this.index=new v({filehandle:new L(i)});else if(t)this.index=new v({filehandle:new C(`${t}.bai`)});else if(n)this.index=new v({filehandle:new L(`${n}.bai`)});else if(f)this.htsget=!0;else throw new Error("unable to infer index format");this.yieldThreadTime=h}async getHeaderPre(e){const t=ee(e);if(!this.index)return;const n=await this.index.parse(t),r=n.firstDataLine?n.firstDataLine.blockPosition+65535:void 0;let s;if(r){const f=r+$,h=await this.bam.read(y.Buffer.alloc(f),0,f,0,t);if(!h.bytesRead)throw new Error("Error reading header");s=h.buffer.subarray(0,Math.min(h.bytesRead,r))}else s=await this.bam.readFile(t);const i=await P(s);if(i.readInt32LE(0)!==V)throw new Error("Not a BAM file");const c=i.readInt32LE(4);this.header=i.toString("utf8",8,8+c);const{chrToIndex:a,indexToChr:d}=await this._readRefSeqs(c+8,65535,t);return this.chrToIndex=a,this.indexToChr=d,j(this.header)}getHeader(e){return this.headerP||(this.headerP=this.getHeaderPre(e).catch(t=>{throw this.headerP=void 0,t})),this.headerP}async getHeaderText(e={}){return await this.getHeader(e),this.header}async _readRefSeqs(e,t,n){if(e>t)return this._readRefSeqs(e,t*2,n);const r=t+$,{bytesRead:s,buffer:i}=await this.bam.read(y.Buffer.alloc(r),0,t,0,n);if(!s)throw new Error("Error reading refseqs from header");const c=await P(i.subarray(0,Math.min(s,t))),a=c.readInt32LE(e);let d=e+4;const f={},h=[];for(let l=0;l<a;l+=1){const x=c.readInt32LE(d),m=this.renameRefSeq(c.toString("utf8",d+4,d+4+x-1)),b=c.readInt32LE(d+x+4);if(f[m]=l,h.push({refName:m,length:b}),d=d+8+x,d>c.length)return console.warn(`BAM header is very big.  Re-fetching ${t} bytes.`),this._readRefSeqs(e,t*2,n)}return{chrToIndex:f,indexToChr:h}}async getRecordsForRange(e,t,n,r){return le(this.streamRecordsForRange(e,t,n,r))}async*streamRecordsForRange(e,t,n,r){var s;await this.getHeader(r);const i=(s=this.chrToIndex)===null||s===void 0?void 0:s[e];if(i===void 0||!this.index)yield[];else{const c=await this.index.blocksForRange(i,t-1,n,r);yield*this._fetchChunkFeatures(c,i,t,n,r)}}async*_fetchChunkFeatures(e,t,n,r,s={}){const{viewAsPairs:i}=s,c=[];let a=!1;for(const d of e){const f=await this.featureCache.get(d.toString(),{chunk:d,opts:s},s.signal),h=[];for(const l of f)if(l.ref_id===t)if(l.start>=r){a=!0;break}else l.end>=n&&h.push(l);if(c.push(h),yield h,a)break}K(s.signal),i&&(yield this.fetchPairs(t,c,s))}async fetchPairs(e,t,n){const{pairAcrossChr:r,maxInsertSize:s=2e5}=n,i={},c={};t.map(l=>{const x={};for(const m of l){const b=m.name,u=m.id;x[b]||(x[b]=0),x[b]++,c[u]=1}for(const[m,b]of Object.entries(x))b===1&&(i[m]=!0)});const a=[];t.map(l=>{for(const x of l){const m=x.name,b=x.start,u=x.next_pos,g=x.next_refid;this.index&&i[m]&&(r||g===e&&Math.abs(b-u)<s)&&a.push(this.index.blocksForRange(g,u,u+1,n))}});const d=new Map,f=await Promise.all(a);for(const l of f.flat())d.has(l.toString())||d.set(l.toString(),l);return(await Promise.all([...d.values()].map(async l=>{const{data:x,cpositions:m,dpositions:b,chunk:u}=await this._readChunk({chunk:l,opts:n}),g=[];for(const w of await this.readBamFeatures(x,m,b,u))i[w.name]&&!c[w.id]&&g.push(w);return g}))).flat()}async _readRegion(e,t,n={}){const{bytesRead:r,buffer:s}=await this.bam.read(y.Buffer.alloc(t),0,t,e,n);return s.subarray(0,Math.min(r,t))}async _readChunk({chunk:e,opts:t}){const n=await this._readRegion(e.minv.blockPosition,e.fetchedSize(),t),{buffer:r,cpositions:s,dpositions:i}=await Q(n,e);return{data:r,cpositions:s,dpositions:i,chunk:e}}async readBamFeatures(e,t,n,r){let s=0;const i=[];let c=0,a=+Date.now();for(;s+4<e.length;){const d=e.readInt32LE(s),f=s+4+d-1;if(n){for(;s+r.minv.dataPosition>=n[c++];);c--}if(f<e.length){const h=new R({bytes:{byteArray:e,start:s,end:f},fileOffset:t.length>0?t[c]*256+(s-n[c])+r.minv.dataPosition+1:ce.signed(e.slice(s,f))});i.push(h),this.yieldThreadTime&&+Date.now()-a>this.yieldThreadTime&&(await J(1),a=+Date.now())}s=f+1}return i}async hasRefSeq(e){var t,n;const r=(t=this.chrToIndex)===null||t===void 0?void 0:t[e];return r===void 0?!1:(n=this.index)===null||n===void 0?void 0:n.hasRefSeq(r)}async lineCount(e){var t;const n=(t=this.chrToIndex)===null||t===void 0?void 0:t[e];return n===void 0||!this.index?0:this.index.lineCount(n)}async indexCov(e,t,n){var r;if(!this.index)return[];await this.index.parse();const s=(r=this.chrToIndex)===null||r===void 0?void 0:r[e];return s===void 0?[]:this.index.indexCov(s,t,n)}async blocksForRange(e,t,n,r){var s;if(!this.index)return[];await this.index.parse();const i=(s=this.chrToIndex)===null||s===void 0?void 0:s[e];return i===void 0?[]:this.index.blocksForRange(i,t,n,r)}}async function U(o,e){const t=await Promise.all(o.map(async n=>{const{url:r,headers:s}=n;if(r.startsWith("data:"))return y.Buffer.from(r.split(",")[1],"base64");{const{referer:i,...c}=s,a=await fetch(r,{...e,headers:{...e==null?void 0:e.headers,...c}});if(!a.ok)throw new Error(`HTTP ${a.status} fetching ${r}: ${await a.text()}`);return y.Buffer.from(await a.arrayBuffer())}}));return y.Buffer.concat(await Promise.all(t.map(n=>P(n))))}class Ee extends ue{constructor(e){super({htsget:!0}),this.baseUrl=e.baseUrl,this.trackId=e.trackId}async*streamRecordsForRange(e,t,n,r){var s;const c=`${`${this.baseUrl}/${this.trackId}`}?referenceName=${e}&start=${t}&end=${n}&format=BAM`,a=(s=this.chrToIndex)===null||s===void 0?void 0:s[e];if(a===void 0)yield[];else{const d=await fetch(c,{...r});if(!d.ok)throw new Error(`HTTP ${d.status} fetching ${c}: ${await d.text()}`);const f=await d.json(),h=await U(f.htsget.urls.slice(1),r);yield*this._fetchChunkFeatures([{buffer:h,_fetchedSize:void 0,bin:0,compareTo(){return 0},toUniqueString(){return`${e}_${t}_${n}`},fetchedSize(){return 0},minv:{dataPosition:0,blockPosition:0,compareTo:()=>0},maxv:{dataPosition:Number.MAX_SAFE_INTEGER,blockPosition:0,compareTo:()=>0},toString(){return`${e}_${t}_${n}`}}],a,t,n,r)}}async _readChunk({chunk:e}){if(!e.buffer)throw new Error("expected chunk.buffer in htsget");return{data:e.buffer,cpositions:[],dpositions:[],chunk:e}}async getHeader(e={}){const t=`${this.baseUrl}/${this.trackId}?referenceName=na&class=header`,n=await fetch(t,e);if(!n.ok)throw new Error(`HTTP ${n.status} fetching ${t}: ${await n.text()}`);const r=await n.json(),s=await U(r.htsget.urls,e);if(s.readInt32LE(0)!==V)throw new Error("Not a BAM file");const i=s.readInt32LE(4),c=s.toString("utf8",8,8+i),a=j(c),d=[],f={},h=a.filter(l=>l.tag==="SQ");for(const[l,x]of h.entries()){let m="",b=0;for(const u of x.data)u.tag==="SN"?m=u.value:u.tag==="LN"&&(b=+u.value);f[m]=l,d[l]={refName:m,length:b}}return this.chrToIndex=f,this.indexToChr=d,a}}export{v as BAI,ue as BamFile,R as BamRecord,T as CSI,Ee as HtsgetFile};
