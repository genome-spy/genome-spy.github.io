import{RemoteFile as Re,LocalFile as De}from"./browser-BgbJyVTA.js";import{A as ue}from"./AbortablePromiseCache-CQdc8xcb.js";import{i as Ne}from"./inflate-b6xj_GGs.js";const fe=BigInt(32);function Le(t,r,e){const n=+!!e,i=+!e;return BigInt(t.getInt32(r,e)*i+t.getInt32(r+4,e)*n)<<fe|BigInt(t.getUint32(r,e)*n+t.getUint32(r+4,e)*i)}function Me(t,r,e){const n=t.getUint32(r,e),i=t.getUint32(r+4,e),o=+!!e,s=+!e;return BigInt(n*s+i*o)<<fe|BigInt(n*o+i*s)}"getBigInt64"in DataView||(DataView.prototype.getBigInt64=function(t,r){return Le(this,t,r)});"getBigUint64"in DataView||(DataView.prototype.getBigUint64=function(t,r){return Me(this,t,r)});var J=function(t,r){return J=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])},J(t,r)};function X(t,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");J(t,r);function e(){this.constructor=t}t.prototype=r===null?Object.create(r):(e.prototype=r.prototype,new e)}function He(t,r,e,n){function i(o){return o instanceof e?o:new e(function(s){s(o)})}return new(e||(e=Promise))(function(o,s){function u(h){try{c(n.next(h))}catch(d){s(d)}}function a(h){try{c(n.throw(h))}catch(d){s(d)}}function c(h){h.done?o(h.value):i(h.value).then(u,a)}c((n=n.apply(t,r||[])).next())})}function le(t,r){var e={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,s=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return s.next=u(0),s.throw=u(1),s.return=u(2),typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(c){return function(h){return a([c,h])}}function a(c){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(e=0)),e;)try{if(n=1,i&&(o=c[0]&2?i.return:c[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,c[1])).done)return o;switch(i=0,o&&(c=[c[0]&2,o.value]),c[0]){case 0:case 1:o=c;break;case 4:return e.label++,{value:c[1],done:!1};case 5:e.label++,i=c[1],c=[0];continue;case 7:c=e.ops.pop(),e.trys.pop();continue;default:if(o=e.trys,!(o=o.length>0&&o[o.length-1])&&(c[0]===6||c[0]===2)){e=0;continue}if(c[0]===3&&(!o||c[1]>o[0]&&c[1]<o[3])){e.label=c[1];break}if(c[0]===6&&e.label<o[1]){e.label=o[1],o=c;break}if(o&&e.label<o[2]){e.label=o[2],e.ops.push(c);break}o[2]&&e.ops.pop(),e.trys.pop();continue}c=r.call(t,e)}catch(h){c=[6,h],i=0}finally{n=o=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function N(t){var r=typeof Symbol=="function"&&Symbol.iterator,e=r&&t[r],n=0;if(e)return e.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")}function Z(t,r){var e=typeof Symbol=="function"&&t[Symbol.iterator];if(!e)return t;var n=e.call(t),i,o=[],s;try{for(;(r===void 0||r-- >0)&&!(i=n.next()).done;)o.push(i.value)}catch(u){s={error:u}}finally{try{i&&!i.done&&(e=n.return)&&e.call(n)}finally{if(s)throw s.error}}return o}function K(t,r,e){if(e||arguments.length===2)for(var n=0,i=r.length,o;n<i;n++)(o||!(n in r))&&(o||(o=Array.prototype.slice.call(r,0,n)),o[n]=r[n]);return t.concat(o||Array.prototype.slice.call(r))}function z(t){return this instanceof z?(this.v=t,this):new z(t)}function je(t,r,e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=e.apply(t,r||[]),i,o=[];return i=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),u("next"),u("throw"),u("return",s),i[Symbol.asyncIterator]=function(){return this},i;function s(f){return function(m){return Promise.resolve(m).then(f,d)}}function u(f,m){n[f]&&(i[f]=function(l){return new Promise(function(B,w){o.push([f,l,B,w])>1||a(f,l)})},m&&(i[f]=m(i[f])))}function a(f,m){try{c(n[f](m))}catch(l){b(o[0][3],l)}}function c(f){f.value instanceof z?Promise.resolve(f.value.v).then(h,d):b(o[0][2],f)}function h(f){a("next",f)}function d(f){a("throw",f)}function b(f,m){f(m),o.shift(),o.length&&a(o[0][0],o[0][1])}}function $e(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t[Symbol.asyncIterator],e;return r?r.call(t):(t=typeof N=="function"?N(t):t[Symbol.iterator](),e={},n("next"),n("throw"),n("return"),e[Symbol.asyncIterator]=function(){return this},e);function n(o){e[o]=t[o]&&function(s){return new Promise(function(u,a){s=t[o](s),i(u,a,s.done,s.value)})}}function i(o,s,u,a){Promise.resolve(a).then(function(c){o({value:c,done:u})},s)}}function O(t){return typeof t=="function"}function he(t){var r=function(n){Error.call(n),n.stack=new Error().stack},e=t(r);return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}var q=he(function(t){return function(e){t(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(n,i){return i+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function ne(t,r){if(t){var e=t.indexOf(r);0<=e&&t.splice(e,1)}}var ee=(function(){function t(r){this.initialTeardown=r,this.closed=!1,this._parentage=null,this._finalizers=null}return t.prototype.unsubscribe=function(){var r,e,n,i,o;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var u=N(s),a=u.next();!a.done;a=u.next()){var c=a.value;c.remove(this)}}catch(l){r={error:l}}finally{try{a&&!a.done&&(e=u.return)&&e.call(u)}finally{if(r)throw r.error}}else s.remove(this);var h=this.initialTeardown;if(O(h))try{h()}catch(l){o=l instanceof q?l.errors:[l]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var b=N(d),f=b.next();!f.done;f=b.next()){var m=f.value;try{ie(m)}catch(l){o=o??[],l instanceof q?o=K(K([],Z(o)),Z(l.errors)):o.push(l)}}}catch(l){n={error:l}}finally{try{f&&!f.done&&(i=b.return)&&i.call(b)}finally{if(n)throw n.error}}}if(o)throw new q(o)}},t.prototype.add=function(r){var e;if(r&&r!==this)if(this.closed)ie(r);else{if(r instanceof t){if(r.closed||r._hasParent(this))return;r._addParent(this)}(this._finalizers=(e=this._finalizers)!==null&&e!==void 0?e:[]).push(r)}},t.prototype._hasParent=function(r){var e=this._parentage;return e===r||Array.isArray(e)&&e.includes(r)},t.prototype._addParent=function(r){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(r),e):e?[e,r]:r},t.prototype._removeParent=function(r){var e=this._parentage;e===r?this._parentage=null:Array.isArray(e)&&ne(e,r)},t.prototype.remove=function(r){var e=this._finalizers;e&&ne(e,r),r instanceof t&&r._removeParent(this)},t.EMPTY=(function(){var r=new t;return r.closed=!0,r})(),t})();ee.EMPTY;function de(t){return t instanceof ee||t&&"closed"in t&&O(t.remove)&&O(t.add)&&O(t.unsubscribe)}function ie(t){O(t)?t():t.unsubscribe()}var Ge={Promise:void 0},We={setTimeout:function(t,r){for(var e=[],n=2;n<arguments.length;n++)e[n-2]=arguments[n];return setTimeout.apply(void 0,K([t,r],Z(e)))},clearTimeout:function(t){return clearTimeout(t)},delegate:void 0};function me(t){We.setTimeout(function(){throw t})}function oe(){}function qe(t){t()}var te=(function(t){X(r,t);function r(e){var n=t.call(this)||this;return n.isStopped=!1,e?(n.destination=e,de(e)&&e.add(n)):n.destination=Je,n}return r.create=function(e,n,i){return new j(e,n,i)},r.prototype.next=function(e){this.isStopped||this._next(e)},r.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},r.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},r.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},r.prototype._next=function(e){this.destination.next(e)},r.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},r.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},r})(ee),Ye=(function(){function t(r){this.partialObserver=r}return t.prototype.next=function(r){var e=this.partialObserver;if(e.next)try{e.next(r)}catch(n){M(n)}},t.prototype.error=function(r){var e=this.partialObserver;if(e.error)try{e.error(r)}catch(n){M(n)}else M(r)},t.prototype.complete=function(){var r=this.partialObserver;if(r.complete)try{r.complete()}catch(e){M(e)}},t})(),j=(function(t){X(r,t);function r(e,n,i){var o=t.call(this)||this,s;return O(e)||!e?s={next:e??void 0,error:n??void 0,complete:i??void 0}:s=e,o.destination=new Ye(s),o}return r})(te);function M(t){me(t)}function Qe(t){throw t}var Je={closed:!0,next:oe,error:Qe,complete:oe},re=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function ge(t){return t}function Ze(t){return t.length===0?ge:t.length===1?t[0]:function(e){return t.reduce(function(n,i){return i(n)},e)}}var _=(function(){function t(r){r&&(this._subscribe=r)}return t.prototype.lift=function(r){var e=new t;return e.source=this,e.operator=r,e},t.prototype.subscribe=function(r,e,n){var i=this,o=Xe(r)?r:new j(r,e,n);return qe(function(){var s=i,u=s.operator,a=s.source;o.add(u?u.call(o,a):a?i._subscribe(o):i._trySubscribe(o))}),o},t.prototype._trySubscribe=function(r){try{return this._subscribe(r)}catch(e){r.error(e)}},t.prototype.forEach=function(r,e){var n=this;return e=se(e),new e(function(i,o){var s=new j({next:function(u){try{r(u)}catch(a){o(a),s.unsubscribe()}},error:o,complete:i});n.subscribe(s)})},t.prototype._subscribe=function(r){var e;return(e=this.source)===null||e===void 0?void 0:e.subscribe(r)},t.prototype[re]=function(){return this},t.prototype.pipe=function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return Ze(r)(this)},t.prototype.toPromise=function(r){var e=this;return r=se(r),new r(function(n,i){var o;e.subscribe(function(s){return o=s},function(s){return i(s)},function(){return n(o)})})},t.create=function(r){return new t(r)},t})();function se(t){var r;return(r=t??Ge.Promise)!==null&&r!==void 0?r:Promise}function Ke(t){return t&&O(t.next)&&O(t.error)&&O(t.complete)}function Xe(t){return t&&t instanceof te||Ke(t)&&de(t)}function et(t){return O(t?.lift)}function R(t){return function(r){if(et(r))return r.lift(function(e){try{return t(e,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}function L(t,r,e,n,i){return new tt(t,r,e,n,i)}var tt=(function(t){X(r,t);function r(e,n,i,o,s,u){var a=t.call(this,e)||this;return a.onFinalize=s,a.shouldUnsubscribe=u,a._next=n?function(c){try{n(c)}catch(h){e.error(h)}}:t.prototype._next,a._error=o?function(c){try{o(c)}catch(h){e.error(h)}finally{this.unsubscribe()}}:t.prototype._error,a._complete=i?function(){try{i()}catch(c){e.error(c)}finally{this.unsubscribe()}}:t.prototype._complete,a}return r.prototype.unsubscribe=function(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;t.prototype.unsubscribe.call(this),!n&&((e=this.onFinalize)===null||e===void 0||e.call(this))}},r})(te),rt=new _(function(t){return t.complete()});function nt(t){return t&&O(t.schedule)}function ye(t){return t[t.length-1]}function it(t){return nt(ye(t))?t.pop():void 0}function ot(t,r){return typeof ye(t)=="number"?t.pop():r}var be=(function(t){return t&&typeof t.length=="number"&&typeof t!="function"});function pe(t){return O(t?.then)}function we(t){return O(t[re])}function ve(t){return Symbol.asyncIterator&&O(t?.[Symbol.asyncIterator])}function Se(t){return new TypeError("You provided "+(t!==null&&typeof t=="object"?"an invalid object":"'"+t+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function st(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var xe=st();function Ie(t){return O(t?.[xe])}function Be(t){return je(this,arguments,function(){var e,n,i,o;return le(this,function(s){switch(s.label){case 0:e=t.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,z(e.read())];case 3:return n=s.sent(),i=n.value,o=n.done,o?[4,z(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,z(i)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function Ue(t){return O(t?.getReader)}function D(t){if(t instanceof _)return t;if(t!=null){if(we(t))return ct(t);if(be(t))return at(t);if(pe(t))return ut(t);if(ve(t))return Oe(t);if(Ie(t))return ft(t);if(Ue(t))return lt(t)}throw Se(t)}function ct(t){return new _(function(r){var e=t[re]();if(O(e.subscribe))return e.subscribe(r);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function at(t){return new _(function(r){for(var e=0;e<t.length&&!r.closed;e++)r.next(t[e]);r.complete()})}function ut(t){return new _(function(r){t.then(function(e){r.closed||(r.next(e),r.complete())},function(e){return r.error(e)}).then(null,me)})}function ft(t){return new _(function(r){var e,n;try{for(var i=N(t),o=i.next();!o.done;o=i.next()){var s=o.value;if(r.next(s),r.closed)return}}catch(u){e={error:u}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}r.complete()})}function Oe(t){return new _(function(r){ht(t,r).catch(function(e){return r.error(e)})})}function lt(t){return Oe(Be(t))}function ht(t,r){var e,n,i,o;return He(this,void 0,void 0,function(){var s,u;return le(this,function(a){switch(a.label){case 0:a.trys.push([0,5,6,11]),e=$e(t),a.label=1;case 1:return[4,e.next()];case 2:if(n=a.sent(),!!n.done)return[3,4];if(s=n.value,r.next(s),r.closed)return[2];a.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return u=a.sent(),i={error:u},[3,11];case 6:return a.trys.push([6,,9,10]),n&&!n.done&&(o=e.return)?[4,o.call(e)]:[3,8];case 7:a.sent(),a.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return r.complete(),[2]}})})}function V(t,r,e,n,i){n===void 0&&(n=0),i===void 0&&(i=!1);var o=r.schedule(function(){e(),i?t.add(this.schedule(null,n)):this.unsubscribe()},n);if(t.add(o),!i)return o}function ke(t,r){return r===void 0&&(r=0),R(function(e,n){e.subscribe(L(n,function(i){return V(n,t,function(){return n.next(i)},r)},function(){return V(n,t,function(){return n.complete()},r)},function(i){return V(n,t,function(){return n.error(i)},r)}))})}function Ee(t,r){return r===void 0&&(r=0),R(function(e,n){n.add(t.schedule(function(){return e.subscribe(n)},r))})}function dt(t,r){return D(t).pipe(Ee(r),ke(r))}function mt(t,r){return D(t).pipe(Ee(r),ke(r))}function gt(t,r){return new _(function(e){var n=0;return r.schedule(function(){n===t.length?e.complete():(e.next(t[n++]),e.closed||this.schedule())})})}function yt(t,r){return new _(function(e){var n;return V(e,r,function(){n=t[xe](),V(e,r,function(){var i,o,s;try{i=n.next(),o=i.value,s=i.done}catch(u){e.error(u);return}s?e.complete():e.next(o)},0,!0)}),function(){return O(n?.return)&&n.return()}})}function Te(t,r){if(!t)throw new Error("Iterable cannot be null");return new _(function(e){V(e,r,function(){var n=t[Symbol.asyncIterator]();V(e,r,function(){n.next().then(function(i){i.done?e.complete():e.next(i.value)})},0,!0)})})}function bt(t,r){return Te(Be(t),r)}function pt(t,r){if(t!=null){if(we(t))return dt(t,r);if(be(t))return gt(t,r);if(pe(t))return mt(t,r);if(ve(t))return Te(t,r);if(Ie(t))return yt(t,r);if(Ue(t))return bt(t,r)}throw Se(t)}function wt(t,r){return r?pt(t,r):D(t)}var vt=he(function(t){return function(){t(this),this.name="EmptyError",this.message="no elements in sequence"}});function _e(t,r){return new Promise(function(e,n){var i=new j({next:function(o){e(o),i.unsubscribe()},error:n,complete:function(){n(new vt)}});t.subscribe(i)})}function Ce(t,r){return R(function(e,n){var i=0;e.subscribe(L(n,function(o){n.next(t.call(r,o,i++))}))})}function St(t,r,e,n,i,o,s,u){var a=[],c=0,h=0,d=!1,b=function(){d&&!a.length&&!c&&r.complete()},f=function(l){return c<n?m(l):a.push(l)},m=function(l){c++;var B=!1;D(e(l,h++)).subscribe(L(r,function(w){r.next(w)},function(){B=!0},void 0,function(){if(B)try{c--;for(var w=function(){var S=a.shift();s||m(S)};a.length&&c<n;)w();b()}catch(S){r.error(S)}}))};return t.subscribe(L(r,f,function(){d=!0,b()})),function(){}}function Pe(t,r,e){return e===void 0&&(e=1/0),O(r)?Pe(function(n,i){return Ce(function(o,s){return r(n,o,i,s)})(D(t(n,i)))},e):(typeof r=="number"&&(e=r),R(function(n,i){return St(n,i,t,e)}))}function xt(t){return t===void 0&&(t=1/0),Pe(ge,t)}function It(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var e=it(t),n=ot(t,1/0),i=t;return i.length?i.length===1?D(i[0]):xt(n)(wt(i,e)):rt}function Bt(t,r,e,n,i){return function(o,s){var u=e,a=r,c=0;o.subscribe(L(s,function(h){var d=c++;a=u?t(a,h,d):(u=!0,h)},(function(){u&&s.next(a),s.complete()})))}}function Ve(t,r){return R(Bt(t,r,arguments.length>=2,!1,!0))}var Ut=function(t,r){return t.push(r),t};function Ot(){return R(function(t,r){Ve(Ut,[])(t).subscribe(r)})}function kt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Y,ce;function Et(){if(ce)return Y;ce=1;class t{constructor(e={}){if(!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");this.maxSize=e.maxSize,this.cache=new Map,this.oldCache=new Map,this._size=0}_set(e,n){this.cache.set(e,n),this._size++,this._size>=this.maxSize&&(this._size=0,this.oldCache=this.cache,this.cache=new Map)}get(e){if(this.cache.has(e))return this.cache.get(e);if(this.oldCache.has(e)){const n=this.oldCache.get(e);return this.oldCache.delete(e),this._set(e,n),n}}set(e,n){return this.cache.has(e)?this.cache.set(e,n):this._set(e,n),this}has(e){return this.cache.has(e)||this.oldCache.has(e)}peek(e){if(this.cache.has(e))return this.cache.get(e);if(this.oldCache.has(e))return this.oldCache.get(e)}delete(e){const n=this.cache.delete(e);return n&&this._size--,this.oldCache.delete(e)||n}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache)yield e;for(const e of this.oldCache){const[n]=e;this.cache.has(n)||(yield e)}}get size(){let e=0;for(const n of this.oldCache.keys())this.cache.has(n)||e++;return this._size+e}}return Y=t,Y}var Tt=Et();const Ae=kt(Tt);class F{ranges;constructor(r){this.ranges=r}get min(){return this.ranges[0].min}get max(){return this.ranges.at(-1).max}contains(r){for(const e of this.ranges)if(e.min<=r&&e.max>=r)return!0;return!1}isContiguous(){return this.ranges.length>1}getRanges(){return this.ranges.map(r=>new F([{min:r.min,max:r.max}]))}toString(){return this.ranges.map(r=>`[${r.min}-${r.max}]`).join(",")}union(r){const e=[...this.getRanges(),...r.getRanges()].sort((o,s)=>o.min<s.min?-1:o.min>s.min?1:o.max<s.max?-1:s.max>o.max?1:0),n=[];let i=e[0];for(const o of e)o.min>i.max+1?(n.push(i),i=o):o.max>i.max&&(i=new F([{min:i.min,max:o.max}]));return n.push(i),n.length===1?n[0]:new F(n)}}function _t(t){return Ne(t.subarray(2),void 0)}class Ct extends Error{code;constructor(r){super(r),this.code="ERR_ABORTED"}}function Pt(t){t.sort((i,o)=>i.offset-o.offset);const r=[];let e,n;for(const i of t)e&&n&&i.offset-n<=2e3?(e.length=e.length+i.length-n+i.offset,e.blocks.push(i)):r.push(e={blocks:[i],length:i.length,offset:i.offset}),n=e.offset+e.length;return r}function H(t){if(t&&t.aborted)if(typeof DOMException>"u"){const r=new Ct("aborted");throw r.code="ERR_ABORTED",r}else throw new DOMException("aborted","AbortError")}const Vt=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function Q(t,r,e,n){return t<n&&r>=e}class ze{bbi;refsByName;cirTreeOffset;isCompressed;blockType;cirTreePromise;featureCache=new ue({cache:new Ae({maxSize:1e3}),fill:async({length:r,offset:e},n)=>this.bbi.read(r,e,{signal:n})});constructor(r,e,n,i,o){if(this.bbi=r,this.refsByName=e,this.cirTreeOffset=n,this.isCompressed=i,this.blockType=o,!(n>=0))throw new Error("invalid cirTreeOffset!")}async readWigData(r,e,n,i,o){try{const s=this.refsByName[r];s===void 0&&i.complete();const u={chrId:s,start:e,end:n};this.cirTreePromise||(this.cirTreePromise=this.bbi.read(48,this.cirTreeOffset,o));const a=await this.cirTreePromise,h=new DataView(a.buffer).getUint32(4,!0);let d=[],b=0;const f=(w,S,x)=>{try{const p=w.subarray(S),g=new DataView(p.buffer,p.byteOffset,p.length);let y=0;const U=g.getUint8(y);y+=2;const T=g.getUint16(y,!0);if(y+=2,U===1){const k=[];for(let I=0;I<T;I++){const E=g.getUint32(y,!0);y+=4;const C=g.getUint32(y,!0);y+=4;const P=g.getUint32(y,!0);y+=4;const $=g.getUint32(y,!0);y+=4;const G=Number(g.getBigUint64(y,!0));y+=8;const W=Number(g.getBigUint64(y,!0));y+=8,k.push({startChrom:E,startBase:C,endBase:$,endChrom:P,blockOffset:G,blockSize:W,offset:y})}d=d.concat(k.filter(I=>m(I)).map(I=>({offset:I.blockOffset,length:I.blockSize})))}else if(U===0){const k=[];for(let E=0;E<T;E++){const C=g.getUint32(y,!0);y+=4;const P=g.getUint32(y,!0);y+=4;const $=g.getUint32(y,!0);y+=4;const G=g.getUint32(y,!0);y+=4;const W=Number(g.getBigUint64(y,!0));y+=8,k.push({startChrom:C,startBase:P,endChrom:$,endBase:G,blockOffset:W,offset:y})}const I=k.filter(E=>m(E)).map(E=>E.blockOffset);I.length>0&&B(I,x+1)}}catch(v){i.error(v)}},m=w=>{const{startChrom:S,startBase:x,endChrom:v,endBase:p}=w;return(S<s||S===s&&x<=n)&&(v>s||v===s&&p>=e)},l=async(w,S,x)=>{try{const v=S.max-S.min,p=S.min,g=await this.featureCache.get(`${v}_${p}`,{length:v,offset:p},o?.signal);for(const y of w)S.contains(y)&&(f(g,y-p,x),b-=1,b===0&&this.readFeatures(i,d,{...o,request:u}).catch(U=>{i.error(U)}))}catch(v){i.error(v)}},B=(w,S)=>{try{b+=w.length;const x=4+h*32;let v=new F([{min:w[0],max:w[0]+x}]);for(let p=1;p<w.length;p+=1){const g=new F([{min:w[p],max:w[p]+x}]);v=v.union(g)}v.getRanges().map(p=>l(w,p,S))}catch(x){i.error(x)}};B([this.cirTreeOffset+48],1);return}catch(s){i.error(s)}}parseSummaryBlock(r,e,n){const i=[];let o=e;const s=new DataView(r.buffer,r.byteOffset,r.length);for(;o<r.byteLength;){const u=s.getUint32(o,!0);o+=4;const a=s.getUint32(o,!0);o+=4;const c=s.getUint32(o,!0);o+=4;const h=s.getUint32(o,!0);o+=4;const d=s.getFloat32(o,!0);o+=4;const b=s.getFloat32(o,!0);o+=4;const f=s.getFloat32(o,!0);o+=4,o+=4,(!n||u===n.chrId&&Q(a,c,n.start,n.end))&&i.push({start:a,end:c,maxScore:b,minScore:d,summary:!0,score:f/(h||1)})}return i}parseBigBedBlock(r,e,n,i){const o=[];let s=e;const u=r,a=new DataView(u.buffer,u.byteOffset,u.length);for(;s<r.byteLength;){const c=s,h=a.getUint32(s,!0);s+=4;const d=a.getInt32(s,!0);s+=4;const b=a.getInt32(s,!0);s+=4;let f=s;for(;f<r.length&&r[f]!==0;f++);const m=r.subarray(s,f),l=Vt?.decode(m)??m.toString();s=f+1,o.push({chromId:h,start:d,end:b,rest:l,uniqueId:`bb-${n+c}`})}return i?o.filter(c=>Q(c.start,c.end,i.start,i.end)):o}parseBigWigBlock(r,e,n){const i=r.subarray(e),o=new DataView(i.buffer,i.byteOffset,i.length);let s=0;s+=4;const u=o.getInt32(s,!0);s+=8;const a=o.getUint32(s,!0);s+=4;const c=o.getUint32(s,!0);s+=4;const h=o.getUint8(s);s+=2;const d=o.getUint16(s,!0);s+=2;const b=new Array(d);switch(h){case 1:{for(let f=0;f<d;f++){const m=o.getInt32(s,!0);s+=4;const l=o.getInt32(s,!0);s+=4;const B=o.getFloat32(s,!0);s+=4,b[f]={start:m,end:l,score:B}}break}case 2:{for(let f=0;f<d;f++){const m=o.getInt32(s,!0);s+=4;const l=o.getFloat32(s,!0);s+=4,b[f]={score:l,start:m,end:m+c}}break}case 3:{for(let f=0;f<d;f++){const m=o.getFloat32(s,!0);s+=4;const l=u+f*a;b[f]={score:m,start:l,end:l+c}}break}}return n?b.filter(f=>Q(f.start,f.end,n.start,n.end)):b}async readFeatures(r,e,n={}){try{const{blockType:i,isCompressed:o}=this,{signal:s,request:u}=n,a=Pt(e);H(s),await Promise.all(a.map(async c=>{H(s);const{length:h,offset:d}=c,b=await this.featureCache.get(`${h}_${d}`,c,s);for(const f of c.blocks){H(s);let m=b.subarray(f.offset-c.offset);switch(o&&(m=_t(m)),H(s),i){case"summary":{r.next(this.parseSummaryBlock(m,0,u));break}case"bigwig":{r.next(this.parseBigWigBlock(m,0,u));break}case"bigbed":{r.next(this.parseBigBedBlock(m,0,f.offset*256,u));break}default:console.warn(`Don't know what to do with ${i}`)}}})),r.complete()}catch(i){r.error(i)}}}const At=-2003829722,ae=-2021002517;function A(t){return new DataView(t.buffer,t.byteOffset,t.length)}class Fe{bbi;headerP;renameRefSeqs;getHeader(r){return this.headerP||(this.headerP=this._getHeader(r).catch(e=>{throw this.headerP=void 0,e})),this.headerP}constructor(r){const{filehandle:e,renameRefSeqs:n=s=>s,path:i,url:o}=r;if(this.renameRefSeqs=n,e)this.bbi=e;else if(o)this.bbi=new Re(o);else if(i)this.bbi=new De(i);else throw new Error("no file given")}async _getHeader(r){const e=await this._getMainHeader(r),n=await this._readChromTree(e,r);return{...e,...n}}async _getMainHeader(r,e=2e3){const n=await this.bbi.read(e,0,r),i=A(n),o=i.getInt32(0,!0);if(o!==At&&o!==ae)throw new Error("not a BigWig/BigBed file");let s=0;const u=i.getInt32(s,!0);s+=4;const a=i.getUint16(s,!0);s+=2;const c=i.getUint16(s,!0);s+=2;const h=Number(i.getBigUint64(s,!0));s+=8;const d=Number(i.getBigUint64(s,!0));s+=8;const b=Number(i.getBigUint64(s,!0));s+=8;const f=i.getUint16(s,!0);s+=2;const m=i.getUint16(s,!0);s+=2;const l=Number(i.getBigUint64(s,!0));s+=8;const B=Number(i.getBigUint64(s,!0));s+=8;const w=i.getUint32(s,!0);s+=4;const S=Number(i.getBigUint64(s,!0));s+=8;const x=[];for(let y=0;y<c;y++){const U=i.getUint32(s,!0);s+=4;const T=i.getUint32(s,!0);s+=4;const k=Number(i.getBigUint64(s,!0));s+=8;const I=Number(i.getBigUint64(s,!0));s+=8,x.push({reductionLevel:U,reserved:T,dataOffset:k,indexOffset:I})}const v=u===ae?"bigbed":"bigwig";if(l>e||B>e-40)return this._getMainHeader(r,e*2);let p;if(B){const y=n.subarray(B);let U=0;const T=A(y),k=Number(T.getBigUint64(U,!0));U+=8;const I=T.getFloat64(U,!0);U+=8;const E=T.getFloat64(U,!0);U+=8;const C=T.getFloat64(U,!0);U+=8;const P=T.getFloat64(U,!0);U+=8,p={scoreMin:I,scoreMax:E,scoreSum:C,scoreSumSquares:P,basesCovered:k}}else throw new Error("no stats");const g=new TextDecoder("utf8");return{zoomLevels:x,magic:u,extHeaderOffset:S,numZoomLevels:c,fieldCount:f,totalSummary:p,definedFieldCount:m,uncompressBufSize:w,asOffset:l,chromTreeOffset:h,totalSummaryOffset:B,unzoomedDataOffset:d,unzoomedIndexOffset:b,fileType:v,version:a,autoSql:l?g.decode(n.subarray(l,n.indexOf(0,l))):""}}async _readChromTree(r,e){const n=[],i={},o=r.chromTreeOffset,s=A(await this.bbi.read(32,o,e));let u=0;u+=4,u+=4;const a=s.getUint32(u,!0);u+=4;const c=s.getUint32(u,!0);u+=4,u+=8;const h=new TextDecoder("utf8"),d=async b=>{const f=await this.bbi.read(4,b),m=A(f);let l=0;const B=m.getUint8(l);l+=1,l+=1;const w=m.getUint16(l,!0);if(l+=2,B){const S=await this.bbi.read(w*(a+c),b+l),x=A(S);l=0;for(let v=0;v<w;v++){const p=h.decode(S.subarray(l,l+a)).replaceAll("\0","");l+=a;const g=x.getUint32(l,!0);l+=4;const y=x.getUint32(l,!0);l+=4,i[this.renameRefSeqs(p)]=g,n[g]={name:p,id:g,length:y}}}else{const S=[],x=A(await this.bbi.read(w*(a+8),b+l));l=0;for(let v=0;v<w;v++){l+=a;const p=Number(x.getBigUint64(l,!0));l+=8,S.push(d(p))}await Promise.all(S)}};return await d(o+32),{refsByName:i,refsByNumber:n}}async getUnzoomedView(r){const{unzoomedIndexOffset:e,refsByName:n,uncompressBufSize:i,fileType:o}=await this.getHeader(r);return new ze(this.bbi,n,e,i>0,o)}async getFeatureStream(r,e,n,i){await this.getHeader(i);const o=this.renameRefSeqs(r);let s;const{basesPerSpan:u,scale:a}=i||{};return u?s=await this.getView(1/u,i):a?s=await this.getView(a,i):s=await this.getView(1,i),new _(c=>{s.readWigData(o,e,n,c,i).catch(h=>{c.error(h)})})}async getFeatures(r,e,n,i){const o=await this.getFeatureStream(r,e,n,i);return(await _e(o.pipe(Ot()))).flat()}}class Nt extends Fe{async getView(r,e){const{zoomLevels:n,refsByName:i,uncompressBufSize:o}=await this.getHeader(e),s=1/r,u=n.length-1;for(let a=u;a>=0;a-=1){const c=n[a];if(c&&c.reductionLevel<=2*s)return new ze(this.bbi,i,c.indexOffset,o>0,"summary")}return this.getUnzoomedView(e)}}function zt(t){return t.filter(r=>!!r)}class Lt extends Fe{readIndicesCache=new ue({cache:new Ae({maxSize:1}),fill:(r,e)=>this._readIndices({...r,signal:e})});readIndices(r={}){const{signal:e,...n}=r;return this.readIndicesCache.get(JSON.stringify(n),r,e)}async getView(r,e){return this.getUnzoomedView(e)}async _readIndices(r){const{extHeaderOffset:e}=await this.getHeader(r),n=await this.bbi.read(64,e),i=new DataView(n.buffer,n.byteOffset,n.length);let o=0;o+=2;const s=i.getUint16(o,!0);o+=2;const u=Number(i.getBigUint64(o,!0));if(o+=8,s===0)return[];const a=20,c=a*s,h=await this.bbi.read(c,u),d=[];for(let b=0;b<s;b+=1){const f=h.subarray(b*a),m=new DataView(f.buffer,f.byteOffset,f.length);let l=0;const B=m.getInt16(l,!0);l+=2;const w=m.getInt16(l,!0);l+=2;const S=Number(m.getBigUint64(l,!0));l+=12;const x=m.getInt16(l,!0);d.push({type:B,fieldcount:w,offset:S,field:x})}return d}async searchExtraIndexBlocks(r,e={}){const n=await this.readIndices(e);if(n.length===0)return[];const i=new TextDecoder("utf8"),o=n.map(async s=>{const{offset:u,field:a}=s,c=await this.bbi.read(32,u,e),h=new DataView(c.buffer,c.byteOffset,c.length);let d=0;d+=4;const b=h.getInt32(d,!0);d+=4;const f=h.getInt32(d,!0);d+=4;const m=h.getInt32(d,!0);d+=4,d+=8;const l=async B=>{const w=B,S=4+b*(f+m),v=await this.bbi.read(S,w,e),p=new DataView(v.buffer,v.byteOffset,v.length);let g=0;const y=p.getInt8(g);g+=2;const U=p.getInt16(g,!0);g+=2;const T=[];if(y===0){const k=[];for(let E=0;E<U;E++){const C=i.decode(v.subarray(g,g+f)).replaceAll("\0","");g+=f;const P=Number(p.getBigUint64(g,!0));g+=8,k.push({key:C,offset:P})}let I=0;for(const{key:E,offset:C}of k){if(r.localeCompare(E)<0&&I)return l(I);I=C}return l(I)}else if(y===1){for(let k=0;k<U;k++){const I=i.decode(v.subarray(g,g+f)).replaceAll("\0","");g+=f;const E=Number(p.getBigUint64(g,!0));g+=8;const C=p.getUint32(g,!0);g+=4;const P=p.getUint32(g,!0);g+=4,T.push({key:I,offset:E,length:C,reserved:P})}for(const k of T)if(k.key===r)return{...k,field:a};return}};return l(u+32)});return zt(await Promise.all(o))}async searchExtraIndex(r,e={}){const n=await this.searchExtraIndexBlocks(r,e);if(n.length===0)return[];const i=await this.getUnzoomedView(e),o=n.map(u=>new _(a=>{i.readFeatures(a,[u],e).catch(c=>{a.error(c)})}).pipe(Ve((a,c)=>a.concat(c)),Ce(a=>{for(const c of a)c.field=u.field;return a})));return(await _e(It(...o))).filter(u=>u.rest?.split("	")[(u.field||0)-3]===r)}}export{Lt as BigBed,Nt as BigWig};
