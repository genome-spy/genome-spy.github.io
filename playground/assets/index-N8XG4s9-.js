const _=/%([0-9A-Fa-f]{2})/g,b=/^\s*##\s*(\S+)\s*(.*)/,C=/\r?\n$/,p=/\s+/,m=/\D/g;function f(n){return n.includes("%")?n.replaceAll(_,(e,r)=>String.fromCharCode(parseInt(r,16))):n}function v(n){if(!n.length||n===".")return{};const e={};let r=n;r.endsWith(`
`)&&(r=r.slice(0,r.endsWith(`\r
`)?-2:-1));for(const t of r.split(";")){const i=t.indexOf("=");if(i===-1)continue;const s=t.slice(i+1);if(!s.length)continue;const o=t.slice(0,i).trim();let c=e[o];c||(c=[],e[o]=c);for(const l of s.split(","))c.push(f(l.trim()))}return e}function F(n){if(!n.length||n===".")return{};const e={};let r=n;r.endsWith(`
`)&&(r=r.slice(0,r.endsWith(`\r
`)?-2:-1));for(const t of r.split(";")){const i=t.indexOf("=");if(i===-1)continue;const s=t.slice(i+1);if(!s.length)continue;const o=t.slice(0,i).trim();let c=e[o];c||(c=[],e[o]=c);for(const l of s.split(","))c.push(l.trim())}return e}function y(n){return d(n.split("	"))}function a(n){return n==="."||n===""||n===void 0?null:n}function d(n){const e=a(n[0]),r=a(n[1]),t=a(n[2]),i=a(n[3]),s=a(n[4]),o=a(n[5]),c=a(n[6]),l=a(n[7]),u=a(n[8]);return{seq_id:e?f(e):null,source:r?f(r):null,type:t?f(t):null,start:i===null?null:parseInt(i,10),end:s===null?null:parseInt(s,10),score:o===null?null:parseFloat(o),strand:c,phase:l,attributes:u===null?null:v(u)}}function R(n){const e=a(n[0]),r=a(n[1]),t=a(n[2]),i=a(n[3]),s=a(n[4]),o=a(n[5]),c=a(n[6]),l=a(n[7]),u=a(n[8]);return{seq_id:e,source:r,type:t,start:i===null?null:parseInt(i,10),end:s===null?null:parseInt(s,10),score:o===null?null:parseFloat(o),strand:c,phase:l,attributes:u===null?null:F(u)}}function g(n){const e=b.exec(n);if(!e)return null;const[,r]=e;let[,,t]=e;const i={directive:r};if(t.length&&(t=t.replace(C,""),i.value=t),r==="sequence-region"){const s=t.split(p,3);return{...i,seq_id:s[0],start:s[1]?.replaceAll(m,""),end:s[2]?.replaceAll(m,"")}}else if(r==="genome-build"){const[s,o]=t.split(p,2);return{...i,source:s,buildName:o}}return i}const k=/^\s*[^#\s>]/,I=/^\s*(#+)(.*)/,L=/^\s*$/,D=/^\s*>/,A=/\r?\n?$/g;class h{featureCallback;endCallback;commentCallback;errorCallback;disableDerivesFromReferences;directiveCallback;bufferSize;eof=!1;lineNumber=0;_underConstructionTopLevel=[];_underConstructionById={};_completedReferences={};_underConstructionOrphans={};constructor(e){const r=()=>{};this.featureCallback=e.featureCallback||r,this.endCallback=e.endCallback||r,this.commentCallback=e.commentCallback||r,this.errorCallback=e.errorCallback||r,this.directiveCallback=e.directiveCallback||r,this.disableDerivesFromReferences=e.disableDerivesFromReferences||!1,this.bufferSize=e.bufferSize===void 0?1/0:e.bufferSize}addLine(e){if(this.eof)return;if(this.lineNumber+=1,k.test(e)){this._bufferLine(e);return}const r=I.exec(e);if(r){const[,t]=r;let[,,i]=r;if(t.length===3)this._emitAllUnderConstructionFeatures();else if(t.length===2){const s=g(e);s&&(s.directive==="FASTA"?(this._emitAllUnderConstructionFeatures(),this.eof=!0):this._emitItem(s))}else this._emitItem({comment:i.trimStart()})}else if(!L.test(e))if(D.test(e))this._emitAllUnderConstructionFeatures(),this.eof=!0;else{const t=e.replaceAll(A,"");throw new Error(`GFF3 parse error.  Cannot parse '${t}'.`)}}addParsedFeatureLine(e){this.eof||(this.lineNumber+=1,this._bufferParsedLine(e))}finish(){this._emitAllUnderConstructionFeatures(),this.endCallback()}_emitItem(e){Array.isArray(e)?this.featureCallback(e):"directive"in e?this.directiveCallback(e):"comment"in e&&this.commentCallback(e)}_enforceBufferSizeLimit(e=0){const r=t=>{t&&Array.isArray(t)&&t[0].attributes?.ID?.[0]&&(t[0].attributes.ID.forEach(s=>{delete this._underConstructionById[s],delete this._completedReferences[s]}),t.forEach(s=>{s.child_features&&s.child_features.forEach(o=>{r(o)}),s.derived_features&&s.derived_features.forEach(o=>{r(o)})}))};for(;this._underConstructionTopLevel.length+e>this.bufferSize;){const t=this._underConstructionTopLevel.shift();t&&(this._emitItem(t),r(t))}}_emitAllUnderConstructionFeatures(){this._underConstructionTopLevel.forEach(this._emitItem.bind(this)),this._underConstructionTopLevel=[],this._underConstructionById={},this._completedReferences={};const e=Object.keys(this._underConstructionOrphans);if(e.length)throw new Error(`some features reference other features that do not exist in the file (or in the same '###' scope). ${e.join(",")}`)}_bufferLine(e){this._bufferParsedLine(y(e))}_bufferParsedLine(e){const r=e;r.child_features=[],r.derived_features=[];const t=r.attributes?.ID||[],i=r.attributes?.Parent||[],s=this.disableDerivesFromReferences?[]:r.attributes?.Derives_from||[];if(!t.length&&!i.length&&!s.length){this._emitItem([r]);return}let o;t.forEach(c=>{const l=this._underConstructionById[c];l?(l[l.length-1].type!==r.type&&this._parseError(`multi-line feature "${c}" has inconsistent types: "${r.type}", "${l[l.length-1].type}"`),l.push(r),o=l):(o=[r],this._enforceBufferSizeLimit(1),!i.length&&!s.length&&this._underConstructionTopLevel.push(o),this._underConstructionById[c]=o,this._resolveReferencesTo(o,c))}),this._resolveReferencesFrom(o||[r],{Parent:i,Derives_from:s},t)}_resolveReferencesTo(e,r){const t=this._underConstructionOrphans[r];if(t){for(const i of e)i.child_features.push(...t.Parent),i.derived_features.push(...t.Derives_from);delete this._underConstructionOrphans[r]}}_parseError(e){this.eof=!0,this.errorCallback(`${this.lineNumber}: ${e}`)}_resolveReferencesFrom(e,r,t){for(const i of r.Parent){const s=this._underConstructionById[i];if(s){let o=!1;for(const c of t){const l=`Parent,${i}`,u=this._completedReferences[c]||(this._completedReferences[c]={});u[l]&&(o=!0),u[l]=!0}if(!o)for(const c of s)c.child_features.push(e)}else{let o=this._underConstructionOrphans[i];o||(o={Parent:[],Derives_from:[]},this._underConstructionOrphans[i]=o),o.Parent.push(e)}}for(const i of r.Derives_from){const s=this._underConstructionById[i];if(s){let o=!1;for(const c of t){const l=`Derives_from,${i}`,u=this._completedReferences[c]||(this._completedReferences[c]={});u[l]&&(o=!0),u[l]=!0}if(!o)for(const c of s)c.derived_features.push(e)}else{let o=this._underConstructionOrphans[i];o||(o={Parent:[],Derives_from:[]},this._underConstructionOrphans[i]=o),o.Derives_from.push(e)}}}}function x(n){const e=[],r=new h({featureCallback:t=>e.push(t),disableDerivesFromReferences:!0,errorCallback:t=>{throw new Error(t)}});for(const t of n.split(/\r?\n/))r.addLine(t);return r.finish(),e}function w(n){const e=[],r=new h({featureCallback:t=>e.push(t),disableDerivesFromReferences:!0,errorCallback:t=>{throw new Error(t)}});for(const t of n)r.addLine(t);return r.finish(),e}function S(n){const e=[],r=new h({featureCallback:t=>e.push(t),disableDerivesFromReferences:!0,errorCallback:t=>{throw new Error(t)}});for(const t of n){const i=d(t.fields);t.lineHash!==void 0&&(i.attributes||(i.attributes={}),i.attributes._lineHash=[String(t.lineHash)]),r.addParsedFeatureLine(i)}return r.finish(),e}function E(n,e){const r=[],t=new h({featureCallback:s=>r.push(s),disableDerivesFromReferences:!0,errorCallback:s=>{throw new Error(s)}}),i=e?d:R;for(const s of n){const o=i(s.fields);s.lineHash!==void 0&&(o.attributes||(o.attributes={}),o.attributes._lineHash=[String(s.lineHash)]),t.addParsedFeatureLine(o)}return t.finish(),r}export{w as parseArraySync,S as parseRecordsSync,E as parseRecordsSyncFast,x as parseStringSync};
