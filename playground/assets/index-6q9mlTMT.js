import{A as J}from"./AbortablePromiseCache-CQdc8xcb.js";import{u as q,Q as U,a as K}from"./unzip-CkEvYgev.js";import{LocalFile as R,RemoteFile as F}from"./browser-BgbJyVTA.js";class L{constructor(e,t,n,i){this.minv=e,this.maxv=t,this.bin=n,this._fetchedSize=i}toUniqueString(){return`${this.minv}..${this.maxv} (bin ${this.bin}, fetchedSize ${this.fetchedSize()})`}toString(){return this.toUniqueString()}compareTo(e){return this.minv.compareTo(e.minv)||this.maxv.compareTo(e.maxv)||this.bin-e.bin}fetchedSize(){return this._fetchedSize!==void 0?this._fetchedSize:this.maxv.blockPosition+65536-this.minv.blockPosition}}class j{constructor({filehandle:e,renameRefSeqs:t=n=>n}){this.filehandle=e,this.renameRefSeq=t}async getMetadata(e={}){const{indices:t,...n}=await this.parse(e);return n}_findFirstData(e,t){return e?e.compareTo(t)>0?t:e:t}async parse(e={}){return this.parseP||(this.parseP=this._parse(e).catch(t=>{throw this.parseP=void 0,t})),this.parseP}async hasRefSeq(e,t={}){return!!(await this.parse(t)).indices[e]?.binIndex}_parseNameBytes(e){let t=0,n=0;const i=[],o={},r=new TextDecoder("utf8");for(let s=0;s<e.length;s+=1)if(!e[s]){if(n<s){const c=this.renameRefSeq(r.decode(e.subarray(n,s)));i[t]=c,o[c]=t}n=s+1,t+=1}return{refNameToId:o,refIdToName:i}}}const H=65536,Z=H*H;function Q(a,e=0){const t=a[e]|a[e+1]<<8|a[e+2]<<16|a[e+3]<<24;return((a[e+4]|a[e+5]<<8|a[e+6]<<16|a[e+7]<<24)>>>0)*Z+(t>>>0)}function ee(a,e){return e.minv.blockPosition-a.maxv.blockPosition<65e3&&e.maxv.blockPosition-a.minv.blockPosition<5e6}function X(a,e){const t=[];let n;if(a.length===0)return a;a.sort(function(i,o){const r=i.minv.blockPosition-o.minv.blockPosition;return r===0?i.minv.dataPosition-o.minv.dataPosition:r});for(const i of a)(!e||i.maxv.compareTo(e)>0)&&(n===void 0?(t.push(i),n=i):ee(n,i)?i.maxv.compareTo(n.maxv)>0&&(n.maxv=i.maxv):(t.push(i),n=i));return t}class E{constructor(e,t){this.blockPosition=e,this.dataPosition=t}toString(){return`${this.blockPosition}:${this.dataPosition}`}compareTo(e){return this.blockPosition-e.blockPosition||this.dataPosition-e.dataPosition}}function A(a,e=0){return new E(a[e+7]*1099511627776+a[e+6]*4294967296+a[e+5]*16777216+a[e+4]*65536+a[e+3]*256+a[e+2],a[e+1]<<8|a[e])}const te=21582659,ne=38359875,ie={0:"generic",1:"SAM",2:"VCF"};function se(a,e){return a*2**e}function W(a,e){return Math.floor(a/2**e)}class V extends j{constructor(e){super(e),this.maxBinNumber=0,this.depth=0,this.minShift=0}async lineCount(e,t={}){const n=await this.parse(t),i=n.refNameToId[e];if(i===void 0||!n.indices[i])return-1;const{stats:r}=n.indices[i];return r?r.lineCount:-1}indexCov(){throw new Error("CSI indexes do not support indexcov")}parseAuxData(e,t){const n=new DataView(e.buffer),i=n.getInt32(t,!0),o=i&65536?"zero-based-half-open":"1-based-closed",r=ie[i&15];if(!r)throw new Error(`invalid Tabix preset format flags ${i}`);const s={ref:n.getInt32(t+4,!0),start:n.getInt32(t+8,!0),end:n.getInt32(t+12,!0)},c=n.getInt32(t+16,!0),u=c?String.fromCharCode(c):void 0,f=n.getInt32(t+20,!0),m=n.getInt32(t+24,!0),{refIdToName:d,refNameToId:l}=this._parseNameBytes(e.subarray(t+28,t+28+m));return{refIdToName:d,refNameToId:l,skipLines:f,metaChar:u,columnNumbers:s,format:r,coordinateType:o}}async _parse(e={}){const t=await q(await this.filehandle.readFile(e)),n=new DataView(t.buffer);let i;if(n.getUint32(0,!0)===te)i=1;else if(n.getUint32(0,!0)===ne)i=2;else throw new Error("Not a CSI file");this.minShift=n.getInt32(4,!0),this.depth=n.getInt32(8,!0),this.maxBinNumber=((1<<(this.depth+1)*3)-1)/7;const o=2**(this.minShift+this.depth*3),r=n.getInt32(12,!0),s=r&&r>=30?this.parseAuxData(t,16):{refIdToName:[],refNameToId:{},metaChar:void 0,columnNumbers:{ref:0,start:1,end:2},coordinateType:"zero-based-half-open",format:"generic"},c=n.getInt32(16+r,!0);let u,f=16+r+4;const m=new Array(c).fill(0).map(()=>{const d=n.getInt32(f,!0);f+=4;const l={};let h;for(let S=0;S<d;S+=1){const C=n.getUint32(f,!0);if(C>this.maxBinNumber)h=this.parsePseudoBin(t,f+4),f+=48;else{const I=A(t,f+4);u=this._findFirstData(u,I);const k=n.getInt32(f+12,!0);f+=16;const w=new Array(k);for(let b=0;b<k;b+=1){const x=A(t,f),g=A(t,f+8);f+=16,w[b]=new L(x,g,C)}l[C]=w}}return{binIndex:l,stats:h}});return{...s,csi:!0,refCount:c,maxBlockSize:65536,firstDataLine:u,csiVersion:i,indices:m,depth:this.depth,maxBinNumber:this.maxBinNumber,maxRefLength:o}}parsePseudoBin(e,t){return{lineCount:Q(e,t+28)}}async blocksForRange(e,t,n,i={}){t<0&&(t=0);const o=await this.parse(i),r=o.refNameToId[e];if(r===void 0)return[];const s=o.indices[r];if(!s)return[];const c=this.reg2bins(t,n),u=[];for(const[f,m]of c)for(let d=f;d<=m;d++)if(s.binIndex[d])for(const l of s.binIndex[d])u.push(new L(l.minv,l.maxv,d));return X(u,new E(0,0))}reg2bins(e,t){e-=1,e<1&&(e=1),t>2**50&&(t=2**34),t-=1;let n=0,i=0,o=this.minShift+this.depth*3;const r=[];for(;n<=this.depth;o-=3,i+=se(1,n*3),n+=1){const s=i+W(e,o),c=i+W(t,o);if(c-s+r.length>this.maxBinNumber)throw new Error(`query ${e}-${t} is too large for current binning scheme (shift ${this.minShift}, depth ${this.depth}), try a smaller query or a coarser index binning scheme`);r.push([s,c])}return r}}const re=21578324,G=14;function ae(a,e){return a+=1,e-=1,[[0,0],[1+(a>>26),1+(e>>26)],[9+(a>>23),9+(e>>23)],[73+(a>>20),73+(e>>20)],[585+(a>>17),585+(e>>17)],[4681+(a>>14),4681+(e>>14)]]}class D extends j{async lineCount(e,t={}){const n=await this.parse(t),i=n.refNameToId[e];return i===void 0||!n.indices[i]?-1:n.indices[i].stats?.lineCount??-1}async _parse(e={}){const t=await this.filehandle.readFile(e),n=await q(t),i=new DataView(n.buffer);if(i.getUint32(0,!0)!==re)throw new Error("Not a TBI file");const r=i.getUint32(4,!0),s=i.getUint32(8,!0),c=s&65536?"zero-based-half-open":"1-based-closed",f={0:"generic",1:"SAM",2:"VCF"}[s&15];if(!f)throw new Error(`invalid Tabix preset format flags ${s}`);const m={ref:i.getInt32(12,!0),start:i.getInt32(16,!0),end:i.getInt32(20,!0)},d=i.getInt32(24,!0),l=5,h=((1<<(l+1)*3)-1)/7,S=2**(14+l*3),C=d?String.fromCharCode(d):void 0,I=i.getInt32(28,!0),k=i.getInt32(32,!0),{refNameToId:w,refIdToName:b}=this._parseNameBytes(n.slice(36,36+k));let x=36+k,g;return{indices:new Array(r).fill(0).map(()=>{const y=i.getInt32(x,!0);x+=4;const B={};let M;for(let T=0;T<y;T+=1){const v=i.getUint32(x,!0);if(x+=4,v>h+1)throw new Error("tabix index contains too many bins, please use a CSI index");if(v===h+1){const _=i.getInt32(x,!0);x+=4,_===2&&(M=this.parsePseudoBin(n,x)),x+=16*_}else{const _=i.getInt32(x,!0);x+=4;const O=new Array(_);for(let z=0;z<_;z+=1){const $=A(n,x),Y=A(n,x+8);x+=16,g=this._findFirstData(g,$),O[z]=new L($,Y,v)}B[v]=O}}const P=i.getInt32(x,!0);x+=4;const N=new Array(P);for(let T=0;T<P;T+=1)N[T]=A(n,x),x+=8,g=this._findFirstData(g,N[T]);return{binIndex:B,linearIndex:N,stats:M}}),metaChar:C,maxBinNumber:h,maxRefLength:S,skipLines:I,firstDataLine:g,columnNumbers:m,coordinateType:c,format:f,refIdToName:b,refNameToId:w,maxBlockSize:65536}}parsePseudoBin(e,t){return{lineCount:Q(e,t+16)}}async blocksForRange(e,t,n,i={}){t<0&&(t=0);const o=await this.parse(i),r=o.refNameToId[e];if(r===void 0)return[];const s=o.indices[r];if(!s)return[];(s.linearIndex.length>0?s.linearIndex[t>>G>=s.linearIndex.length?s.linearIndex.length-1:t>>G]:new E(0,0))||console.warn("querying outside of possible tabix range");const u=ae(t,n),f=[];for(const[S,C]of u)for(let I=S;I<=C;I++)if(s.binIndex[I])for(const k of s.binIndex[I])f.push(new L(k.minv,k.maxv,I));const m=s.linearIndex.length;let d;const l=Math.min(t>>14,m-1),h=Math.min(n>>14,m-1);for(let S=l;S<=h;++S){const C=s.linearIndex[S];C&&(!d||C.compareTo(d)<0)&&(d=C)}return X(f,d)}}class he{constructor({path:e,filehandle:t,url:n,tbiPath:i,tbiUrl:o,tbiFilehandle:r,csiPath:s,csiUrl:c,csiFilehandle:u,renameRefSeqs:f,chunkCacheSize:m=5*2**20}){this.cache=new U({maxSize:1e3});const d=f??(l=>l);if(t)this.filehandle=t;else if(e)this.filehandle=new R(e);else if(n)this.filehandle=new F(n);else throw new TypeError("must provide either filehandle or path");if(r)this.index=new D({filehandle:r,renameRefSeqs:d});else if(u)this.index=new V({filehandle:u,renameRefSeqs:d});else if(i)this.index=new D({filehandle:new R(i),renameRefSeqs:d});else if(s)this.index=new V({filehandle:new R(s),renameRefSeqs:d});else if(e)this.index=new D({filehandle:new R(`${e}.tbi`),renameRefSeqs:d});else if(c)this.index=new V({filehandle:new F(c)});else if(o)this.index=new D({filehandle:new F(o)});else if(n)this.index=new D({filehandle:new F(`${n}.tbi`)});else throw new TypeError("must provide one of tbiFilehandle, tbiPath, csiFilehandle, csiPath, tbiUrl, csiUrl");this.renameRefSeq=d,this.hasCustomRenameRefSeq=f!==void 0,this.chunkCache=new J({cache:new U({maxSize:Math.floor(m/65536)}),fill:(l,h)=>this.readChunk(l,{signal:h})})}calculateFileOffset(e,t,n,i,o){return e[n]*256+(i-t[n])+o+1}async getLines(e,t,n,i){let o,r={},s;typeof i=="function"?s=i:(r=i,s=i.lineCallback,o=i.signal);const c=await this.index.getMetadata(r),u=t??0,f=n??c.maxRefLength;if(!(u<=f))throw new TypeError("invalid start and end coordinates. start must be less than or equal to end");if(u===f)return;const m=await this.index.blocksForRange(e,u,f,r),d=new TextDecoder("utf8"),l=c.format==="VCF",h={ref:c.columnNumbers.ref||0,start:c.columnNumbers.start||0,end:l?8:c.columnNumbers.end||0},S=Math.max(h.ref,h.start,h.end),C=c.metaChar?.charCodeAt(0),I=c.coordinateType==="1-based-closed"?-1:0,k=!this.hasCustomRenameRefSeq;for(const w of m){const{buffer:b,cpositions:x,dpositions:g}=await this.chunkCache.get(w.toString(),w,o);let p=0,y=0;const B=d.decode(b);if(b.length==B.length)for(;p<B.length;){const P=B.indexOf(`
`,p);if(P===-1)break;const N=B.slice(p,P);if(g){const v=p+w.minv.dataPosition;for(;y<g.length&&v>=g[y];)y++}const T=this.checkLine(e,u,f,N,h.ref,h.start,h.end,S,C,I,l,k);if(T===null)return;T!==void 0&&s(N,this.calculateFileOffset(x,g,y,p,w.minv.dataPosition),T.start,T.end),p=P+1}else for(;p<b.length;){const P=b.indexOf(10,p);if(P===-1)break;const N=b.slice(p,P),T=d.decode(N);if(g){const _=p+w.minv.dataPosition;for(;y<g.length&&_>=g[y];)y++}const v=this.checkLine(e,u,f,T,h.ref,h.start,h.end,S,C,I,l,k);if(v===null)return;v!==void 0&&s(T,this.calculateFileOffset(x,g,y,p,w.minv.dataPosition),v.start,v.end),p=P+1}}}async getMetadata(e={}){return this.index.getMetadata(e)}async getHeaderBuffer(e={}){const{firstDataLine:t,metaChar:n,maxBlockSize:i}=await this.getMetadata(e),o=(t?.blockPosition||0)+i,r=await this.filehandle.read(o,0,e),s=await q(r);if(n){let c=-1;const u=10,f=n.charCodeAt(0);for(let m=0,d=s.length;m<d;m++){const l=s[m];if(m===c+1&&l!==f)break;l===u&&(c=m)}return s.subarray(0,c+1)}return s}async getHeader(e={}){const t=new TextDecoder("utf8"),n=await this.getHeaderBuffer(e);return t.decode(n)}async getReferenceSequenceNames(e={}){return(await this.getMetadata(e)).refIdToName}checkLine(e,t,n,i,o,r,s,c,u,f,m,d){if(u!==void 0&&i.charCodeAt(0)===u)return;if(i.length<500){const w=i.split("	"),b=w[o-1];if(!(d?b===e:this.renameRefSeq(b)===e))return;const g=+w[r-1]+f;if(g>=n)return null;let p;return s===0||s===r?p=g+1:m?p=this._getVcfEnd(g,w[3],w[s-1]):p=+w[s-1],p<=t?void 0:{start:g,end:p}}let l=-1;const h=[-1];for(let w=0;w<c;w++){const b=i.indexOf("	",l+1);if(b===-1){h.push(i.length);break}h.push(b),l=b}const S=i.slice(h[o-1]+1,h[o]);if(!(d?S===e:this.renameRefSeq(S)===e))return;const I=+i.slice(h[r-1]+1,h[r])+f;if(I>=n)return null;let k;if(s===0||s===r?k=I+1:m?k=this._getVcfEnd(I,i.slice(h[3]+1,h[4]),i.slice(h[s-1]+1,h[s])):k=+i.slice(h[s-1]+1,h[s]),!(k<=t))return{start:I,end:k}}_getVcfEnd(e,t,n){let i=e+t.length;if(n.includes("SVTYPE=TRA"))return e+1;if(n[0]!=="."){const r=n.indexOf("END=");if(r!==-1&&(r===0||n[r-1]===";")){const s=r+4;let c=n.indexOf(";",s);c===-1&&(c=n.length),i=Number.parseInt(n.slice(s,c),10)}}return i}async lineCount(e,t={}){return this.index.lineCount(e,t)}async readChunk(e,t={}){const n=await this.filehandle.read(e.fetchedSize(),e.minv.blockPosition,t);return K(n,e,this.cache)}}export{V as CSI,D as TBI,he as TabixIndexedFile};
